databaseChangeLog:
  - changeSet:
      id: 004-suppliers-offers
      author: you
      changes:
        - createTable:
            tableName: supplier
            columns:
              - column: { name: id, type: uuid, constraints: { primaryKey: true, nullable: false } }
              - column: { name: name, type: varchar(255), constraints: { nullable: false } }
              - column: { name: phone, type: varchar(64) }
              - column: { name: email, type: varchar(255) }
              - column: { name: notes, type: text }
              - column: { name: is_active, type: boolean, constraints: { nullable: false } }
              - column: { name: created_at, type: timestamptz, constraints: { nullable: false } }

        - addUniqueConstraint:
            tableName: supplier
            columnNames: name
            constraintName: uq_supplier_name

        - createTable:
            tableName: supplier_material
            columns:
              - column: { name: id, type: uuid, constraints: { primaryKey: true, nullable: false } }
              - column: { name: supplier_id, type: uuid, constraints: { nullable: false } }
              - column: { name: raw_material_id, type: uuid, constraints: { nullable: false } }
              - column: { name: package_size, type: numeric(14,6), constraints: { nullable: false } }
              - column: { name: package_unit, type: varchar(32), constraints: { nullable: false } }
              - column: { name: sku, type: varchar(128) }
              - column: { name: link, type: varchar(2048) }
              - column: { name: is_active, type: boolean, constraints: { nullable: false } }
              - column: { name: created_at, type: timestamptz, constraints: { nullable: false } }

        - addForeignKeyConstraint:
            baseTableName: supplier_material
            baseColumnNames: supplier_id
            referencedTableName: supplier
            referencedColumnNames: id
            constraintName: fk_offer_supplier

        - addForeignKeyConstraint:
            baseTableName: supplier_material
            baseColumnNames: raw_material_id
            referencedTableName: raw_material
            referencedColumnNames: id
            constraintName: fk_offer_raw_material

        - createIndex:
            tableName: supplier_material
            indexName: ix_offer_raw
            columns:
              - column: { name: raw_material_id }

        - createTable:
            tableName: supplier_material_price
            columns:
              - column: { name: id, type: uuid, constraints: { primaryKey: true, nullable: false } }
              - column: { name: supplier_material_id, type: uuid, constraints: { nullable: false } }
              - column: { name: price_per_package, type: numeric(14,6), constraints: { nullable: false } }
              - column: { name: currency, type: varchar(8), constraints: { nullable: false } }
              - column: { name: valid_from, type: date, constraints: { nullable: false } }
              - column: { name: valid_to, type: date }
              - column: { name: created_at, type: timestamptz, constraints: { nullable: false } }

        - addForeignKeyConstraint:
            baseTableName: supplier_material_price
            baseColumnNames: supplier_material_id
            referencedTableName: supplier_material
            referencedColumnNames: id
            constraintName: fk_offer_price_offer

        - createIndex:
            tableName: supplier_material_price
            indexName: ix_offer_price_offer_validfrom
            columns:
              - column: { name: supplier_material_id }
              - column: { name: valid_from }

        - createTable:
            tableName: raw_material_default_offer
            columns:
              - column: { name: raw_material_id, type: uuid, constraints: { primaryKey: true, nullable: false } }
              - column: { name: supplier_material_id, type: uuid, constraints: { nullable: false } }
              - column: { name: created_at, type: timestamptz, constraints: { nullable: false } }

        - addForeignKeyConstraint:
            baseTableName: raw_material_default_offer
            baseColumnNames: raw_material_id
            referencedTableName: raw_material
            referencedColumnNames: id
            constraintName: fk_default_offer_raw

        - addForeignKeyConstraint:
            baseTableName: raw_material_default_offer
            baseColumnNames: supplier_material_id
            referencedTableName: supplier_material
            referencedColumnNames: id
            constraintName: fk_default_offer_offer

        - createTable:
            tableName: batch_supplier_selection
            columns:
              - column: { name: batch_id, type: uuid, constraints: { nullable: false } }
              - column: { name: raw_material_id, type: uuid, constraints: { nullable: false } }
              - column: { name: supplier_material_id, type: uuid, constraints: { nullable: false } }
              - column: { name: created_at, type: timestamptz, constraints: { nullable: false } }

        - addPrimaryKey:
            tableName: batch_supplier_selection
            columnNames: batch_id, raw_material_id
            constraintName: pk_batch_supplier_selection

        - addForeignKeyConstraint:
            baseTableName: batch_supplier_selection
            baseColumnNames: batch_id
            referencedTableName: batch
            referencedColumnNames: id
            constraintName: fk_bss_batch

        - addForeignKeyConstraint:
            baseTableName: batch_supplier_selection
            baseColumnNames: raw_material_id
            referencedTableName: raw_material
            referencedColumnNames: id
            constraintName: fk_bss_raw

        - addForeignKeyConstraint:
            baseTableName: batch_supplier_selection
            baseColumnNames: supplier_material_id
            referencedTableName: supplier_material
            referencedColumnNames: id
            constraintName: fk_bss_offer
